#!/usr/bin/env bash

function tag_header () {
  TAG=$1
  DATE=`git --no-pager log --date=short --pretty="format: %cd" --max-count=1 $TAG`
  HEAD="\n## [${TAG:1:${#TAG}}] -${DATE:0:${#DATE}}\n"
  if [ $TAG = "HEAD" ]; then
    HEAD="\n## [Unreleased][unreleased]\n"
  fi
  # for i in $(seq 5 ${#HEAD}); do HEAD="$HEAD="; done
  HEAD="$HEAD\n\n"
  echo -e "$HEAD";
}

LAST_TAG=HEAD
for TAG in `git for-each-ref --format="%(tag)" --sort='*authordate' refs/tags | sed '1!G;h;$!d'`; do
  if [ -z "$LAST_TAG" ]; then
    LAST_TAG=$TAG
    continue
  fi

  echo -e "$(tag_header $LAST_TAG)"
  # ^1 here prevents the tag commit
  git --no-pager log --pretty="format:- [%h] %s (\`%an\`)" "$TAG".."$LAST_TAG"
  echo ""

  LAST_TAG=$TAG
done

